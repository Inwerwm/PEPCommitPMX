# Commit PMX 説明書

## 導入
PMXエディターでモデルを編集していると、時々編集状態を前に戻したくなったりしませんか？  
でも手作業でモデルのバックアップを取るのはめんどくさい…  
そんな悩みを解消するために、今回紹介する Commit PMX プラグインを作成しました！

## 概要
Commit PMX プラグインは以下の機能を持ちます：
- 日時・メッセージ付きで編集履歴アーカイブにモデルを保存
- 編集履歴アーカイブの自動圧縮
- 任意履歴の現在編集状態への上書き

概要だけではよくわからないと思うので、実際の使い方も説明していきます。

## 使い方
プラグインを起動したとき、履歴データを保存するための`CommitLog_モデル名`フォルダがモデルと同じ階層に作成されます。

まだこのモデルに編集履歴が存在しない場合、編集をする前に初期状態を履歴に追加しておきましょう。

それでは、モデルに編集を加えていき、適宜メッセージつきで履歴に現在状態を保存していきます。  
編集履歴はテキストボックスに編集内容の説明を書いた後、コミットボタンをクリックするか Ctrl + Enter キーを押すことで保存できます。  
このとき、PMXエディター側では未保存状態扱いになっていますが、実際には元のモデルも上書き保存されている点に注意してください。

`復元ファイルを選択`ボタンをクリックすると、これまでの編集履歴を一覧表示させることができます。  
履歴の一つを選択した状態で`ログフォルダに解凍`ボタンをクリックすると、`CommitLog_モデル名`フォルダに履歴モデルが解凍されます。  
`現在状態に上書き`ボタンを押すと、現在のPMXエディタ内のモデルの状態をその履歴保存時点に戻すことができます。  
`削除`ボタンを押すと履歴の削除が可能ですが、ここで削除された履歴モデルはゴミ箱に入らず完全に消去されてしまうので注意してください。

`アーカイブを再圧縮`ボタンを押すと、履歴モデルを保存している`archive.7z`ファイルを一度展開してからもう一度圧縮します。  
再圧縮を行うことで、アーカイブファイルの容量を減らすことができます。  
圧縮アルゴリズムの都合上、ファイルをひとつずつ圧縮して追加するよりも、複数のファイルを一気に圧縮したほうが圧縮率は良くなるためです。
編集量にも影響を受けますが、多くの場合かなりの容量削減が期待できます。  
もっとも、圧縮率高めの設定で再圧縮をするので、履歴の数とPCスペックにもよりますがそこそこ時間がかかります。  
なので、編集を終えた後、エディタを閉じる前に実行することをおすすめします。

## 注意事項

`CommitLog_モデル名`フォルダの中身は、`ログファイルに解凍`ボタンを押してできたファイルを除き、基本的に触らないことを推奨します。  
CommitLog.txtの中身の形式が崩れると編集履歴を読み込めなくなりますし、archiveファイルに他プロセスからアクセスされている場合、圧縮ファイルを追加できない事態が発生することがあります。

圧縮方式として、7zとzipが選べますが、特段の理由がない限りより圧縮率の良い7zを使うことをおすすめします。  
zip形式ならarchive.zipの中身をエクスプローラで見れるという利点がありますが、7zでも7-Zipをインストールしておけば、7-Zip File Manager を使って中身を見ることができます。  

## 7-Zipについて
このプラグインでは圧縮のために[7-Zip](https://sevenzip.osdn.jp/)を使用しています。  
プラグインに同梱されている`7z.cdll`が7-Zipのライブラリです。  
プラグインで使用する7-Zipのバージョンを上げたい場合、そのバージョンの7-Zipをインストールし、インストールフォルダ内の`7z.dll`をプラグインと同じフォルダにコピー後、名前を`7z.cdll`に変更して上書きしてください。

## おわりに
こまめに履歴を残すことで、編集状態の巻き戻しのほか、行った編集の一覧表示としても活用することができます。  
また、履歴はpmxのファイル名から生成したフォルダに保存されるので、モデルのファイル名を変更すれば編集状態の分岐も行うことができます。  
バージョン管理を適切に行えば、不可逆な変更も怖くありません。  
Commit PMX を使って、よいモデル編集ライフをおくろう！